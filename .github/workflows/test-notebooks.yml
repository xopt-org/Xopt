name: Test Notebooks

on:
  pull_request:
  push:
    branches-ignore:
      - main

jobs:
  test-notebooks:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        group: [1, 2, 3, 4]

    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libopenmpi-dev ffmpeg

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Execute notebooks in parallel
        id: execute
        shell: bash
        env:
          GROUP: ${{ matrix.group }}
          TOTAL_GROUPS: 4
          SMOKE_TEST: "True"
        run: |
          # Use shared script to execute notebooks for this group
          bash scripts/run_notebooks.sh "$GROUP" "$TOTAL_GROUPS" "Group $GROUP" > group-$GROUP-summary.md

          # Parse summary counts from the markdown written by the script
          TOTAL=$(grep "^- Total:" group-$GROUP-summary.md | awk '{print $3}')
          SUCCESS=$(grep "^- Success:" group-$GROUP-summary.md | awk '{print $3}')
          FAILED=$(grep "^- Failed:" group-$GROUP-summary.md | awk '{print $3}')

          # Append group summary markdown to GitHub step summary
          cat group-$GROUP-summary.md >> "$GITHUB_STEP_SUMMARY"

          # Export for next step
          echo "failed=$FAILED" >> "$GITHUB_OUTPUT"
          echo "success=$SUCCESS" >> "$GITHUB_OUTPUT"
          echo "total=$TOTAL" >> "$GITHUB_OUTPUT"

          [ "$FAILED" -gt 0 ] && exit 1 || exit 0

      - name: Save results for summary
        if: always()
        run: |
          mkdir -p results
          echo "${{ steps.execute.outputs.success }},${{ steps.execute.outputs.failed }},${{ steps.execute.outputs.total }}" > results/group-${{ matrix.group }}-results.txt

      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-group-${{ matrix.group }}
          path: results/group-${{ matrix.group }}-results.txt

      - name: Minimize uv cache
        run: uv cache prune --ci

  summary:
    name: "Notebook Execution Summary"
    needs: test-notebooks
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: results-group-*
          merge-multiple: true

      - name: Generate overall summary
        run: |
          echo "# ðŸ“Š Notebook Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TOTAL_SUCCESS=0
          TOTAL_FAILED=0
          TOTAL_NOTEBOOKS=0

          echo "## Results by Group" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Group | Total | Success âœ… | Failed âŒ |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|-----------|----------|" >> $GITHUB_STEP_SUMMARY

          for i in 1 2 3 4; do
            if [ -f "group-$i-results.txt" ]; then
              IFS=',' read -r success failed total < "group-$i-results.txt"
              echo "| $i | $total | $success | $failed |" >> $GITHUB_STEP_SUMMARY
              TOTAL_SUCCESS=$((TOTAL_SUCCESS + success))
              TOTAL_FAILED=$((TOTAL_FAILED + failed))
              TOTAL_NOTEBOOKS=$((TOTAL_NOTEBOOKS + total))
            else
              echo "| $i | - | - | âš ï¸ No results |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ˆ Overall Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Notebooks**: $TOTAL_NOTEBOOKS" >> $GITHUB_STEP_SUMMARY
          echo "- **âœ… Successful**: $TOTAL_SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "- **âŒ Failed**: $TOTAL_FAILED" >> $GITHUB_STEP_SUMMARY

          if [ $TOTAL_FAILED -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Some notebooks failed.** Check individual group summaries above for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **All notebooks executed successfully!**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Check individual group job summaries for detailed notebook-by-notebook results.*" >> $GITHUB_STEP_SUMMARY
